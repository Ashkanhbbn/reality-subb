# NekoBox Ultimate Config (v5) - Fixed Connection Issues
# Last Updated: 2025-06-27

# ---------------------------
# Proxies (Reality)
# ---------------------------
proxies:
  - name: "Reality | Global CDN"
    type: vless
    server: bug.cloudflare.com
    port: 443
    uuid: de305d54-75b4-431b-adb2-eb6b9e546013
    cipher: none
    tls: true
    network: tcp
    reality-opts:
      public-key: J4qJrcRWbW9KOPkz9e3h3q3nlkIisTD4xTx9fbsWRUg
      short-id: "b4c0d3f1"
      spider-x: /
      server-name: www.google.com
    client-fingerprint: chrome
    udp: true

  - name: "Reality | Media Stream"
    type: vless
    server: bug.cloudflare.com
    port: 443
    uuid: de305d54-75b4-431b-adb2-eb6b9e546013
    cipher: none
    tls: true
    network: tcp
    reality-opts:
      public-key: J4qJrcRWbW9KOPkz9e3h3q3nlkIisTD4xTx9fbsWRUg
      short-id: "e1f2a3c4"
      spider-x: /
      server-name: www.bing.com
    client-fingerprint: chrome
    udp: true

  - name: "Reality | Cloud Gateway"
    type: vless
    server: bug.cloudflare.com
    port: 443
    uuid: de305d54-75b4-431b-adb2-eb6b9e546013
    cipher: none
    tls: true
    network: tcp
    reality-opts:
      public-key: J4qJrcRWbW9KOPkz9e3h3q3nlkIisTD4xTx9fbsWRUg
      short-id: "11223344"
      spider-x: /
      server-name: cloudflare.com
    client-fingerprint: chrome
    udp: true

# ---------------------------
# Proxy Groups
# ---------------------------
proxy-groups:
  - name: "Reality-Main"
    type: fallback
    url: "http://connectivitycheck.android.com/generate_204"  # تست اضطراری
    interval: 300
    tolerance: 100
    lazy: true
    disable-udp: false
    proxies:
      - "Reality | Global CDN"
      - "Reality | Media Stream"
      - "Reality | Cloud Gateway"

  - name: "Auto-Fallback"
    type: fallback
    url: "http://www.apple.com/library/test/success.html"  # تست جایگزین
    interval: 600
    proxies:
      - "Reality-Main"
      - DIRECT  # حالت اضطراری

# ---------------------------
# DNS Configuration
# ---------------------------
dns:
  enable: true
  ipv6: false
  prefer-h3: false  # غیرفعال برای پایداری
  enhanced-mode: redir-host
  nameserver:
    - "udp://1.1.1.1"  # حالت اضطراری UDP
    - "https://dns.cloudflare.com/dns-query"
  fallback:
    - "udp://8.8.4.4"
    - "tls://dns10.quad9.net:853"
  fallback-filter:
    geoip: true
    ipcidr:
      - 0.0.0.0/32

# ---------------------------
# Rules
# ---------------------------
rules:
  # Critical Services
  - DOMAIN,clients3.google.com,DIRECT
  - DOMAIN-SUFFIX,google.com,DIRECT
  - DOMAIN-SUFFIX,gstatic.com,DIRECT
  - DOMAIN-SUFFIX,cloudflare.com,DIRECT
  - DOMAIN-SUFFIX,android.com,DIRECT
  - DOMAIN-SUFFIX,apple.com,DIRECT
  
  # Local Services
  - DOMAIN-SUFFIX,ir,DIRECT
  - DOMAIN-SUFFIX,cn,DIRECT
  - GEOIP,IR,DIRECT
  - GEOIP,CN,DIRECT
  - GEOIP,PRIVATE,DIRECT
  
  # CDN Acceleration
  - DOMAIN-SUFFIX,akamai.net,Reality-Main
  - DOMAIN-SUFFIX,cloudfront.net,Reality-Main
  
  # Final Rule
  - MATCH,Auto-Fallback
